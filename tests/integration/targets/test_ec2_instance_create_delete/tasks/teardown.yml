---
- name: Teardown
  block:
    - name: Delete Subnets
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ test_vpc_id }}"
        cidr: "{{ test_subnet_cidr }}"
        region: "{{ aws_region }}"
        state: absent
      ignore_errors: true

    - name: Get list of route tables in VPC
      amazon.aws.ec2_vpc_route_table_info:
        region: "{{ aws_region }}"
        filters:
          vpc-id: "{{ vpc_id }}"
      register: route_tables

    - name: Delete route tables associated with VPC
      amazon.aws.ec2_vpc_route_table:
        region: "{{ region }}"
        route_table_id: "{{ item.route_table_id }}"
        state: absent
      loop: "{{ route_tables.route_tables }}"
      when: route_tables.route_tables | length > 0
      ignore_errors: true

    - name: Delete a VPC
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ test_vpc_cidr }}"
        vpc_id: "{{ test_vpc_id }}"
        region: "{{ aws_region }}"
        state: absent
      register: delete_result
      ignore_errors: true
      retries: 5
      delay: 5
      until: delete_result.changed

    - name: Delete a key
      amazon.aws.ec2_key:
        name: "{{ resource_prefix }}-ec2-key"
        region: "{{ aws_region }}"
        state: absent
      ignore_errors: true
