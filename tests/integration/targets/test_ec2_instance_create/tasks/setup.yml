---
- name: Setup
  block:
    - name: Get AMI image ID using filters
      amazon.aws.ec2_ami_info:
        region: "{{ aws_region }}"
        filters:
          architecture: x86_64
          # CentOS Community Platform Engineering (CPE)
          owner-id: "125523088429"
          virtualization-type: hvm
          root-device-type: ebs
          name: Fedora-Cloud-Base-*
      register: images
      # very spammy
      no_log: true

    - name: Create vpc to work in
      amazon.aws.ec2_vpc_net:
        cidr_block: "{{ test_vpc_cidr }}"
        name: "{{ test_vpc_name }}"
        state: present
        region: "{{ aws_region }}"
      register: vpc

    - name: Define VPC id
      ansible.builtin.set_fact:
        test_vpc_id: "{{ vpc.vpc.id }}"

    - name: Create EC2 subnet
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ test_vpc_id }}"
        cidr: "{{ test_subnet_cidr }}"
        az: "{{ aws_region }}a"
        region: "{{ aws_region }}"
      register: subnet

    - name: Create a key
      amazon.aws.ec2_key:
        name: "{{ ec2_key_name }}"
        state: present
        region: "{{ aws_region }}"
      register: ec2_key_result

    - name: Set facts for test resources
      ansible.builtin.set_fact:
        image_id: "{{ images.images.0.image_id }}"
        subnet_id: "{{ subnet.subnet.id }}"
        vpc_id: "{{ vpc.vpc.id }}"
